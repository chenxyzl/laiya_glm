# !/usr/bin/env python3
"""
==== No Bugs in code, just some Random Unexpected FEATURES ====
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”â”‚
â”‚â”‚Escâ”‚!1 â”‚@2 â”‚#3 â”‚$4 â”‚%5 â”‚^6 â”‚&7 â”‚*8 â”‚(9 â”‚)0 â”‚_- â”‚+= â”‚|\ â”‚`~ â”‚â”‚
â”‚â”œâ”€â”€â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”€â”€â”¤â”‚
â”‚â”‚ Tab â”‚ Q â”‚ W â”‚ E â”‚ R â”‚ T â”‚ Y â”‚ U â”‚ I â”‚ O â”‚ P â”‚{[ â”‚}] â”‚ BS  â”‚â”‚
â”‚â”œâ”€â”€â”€â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”€â”€â”€â”€â”€â”¤â”‚
â”‚â”‚ Ctrl â”‚ A â”‚ S â”‚ D â”‚ F â”‚ G â”‚ H â”‚ J â”‚ K â”‚ L â”‚: ;â”‚" 'â”‚ Enter  â”‚â”‚
â”‚â”œâ”€â”€â”€â”€â”€â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”¤â”‚
â”‚â”‚ Shift  â”‚ Z â”‚ X â”‚ C â”‚ V â”‚ B â”‚ N â”‚ M â”‚< ,â”‚> .â”‚? /â”‚Shift â”‚Fn â”‚â”‚
â”‚â””â”€â”€â”€â”€â”€â”¬â”€â”€â”´â”¬â”€â”€â”´â”€â”€â”¬â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”¬â”´â”€â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜â”‚
â”‚      â”‚Fn â”‚ Alt â”‚         Space         â”‚ Alt â”‚Winâ”‚   HHKB   â”‚
â”‚      â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ©ç”¨ LLM è¿›è¡Œæ–‡æœ¬åˆ†ç±»ä»»åŠ¡ã€‚

Author: pankeyu
Date: 2023/03/17
"""
from rich import print
from rich.console import Console
from transformers import AutoTokenizer, AutoModel


# æä¾›æ‰€æœ‰ç±»åˆ«ä»¥åŠæ¯ä¸ªç±»åˆ«ä¸‹çš„æ ·ä¾‹
class_examples = {
        'æœ‰è½¦å—':'çº¦ç©',
        'è°å¸¦æˆ‘ä¸€ä¸‹':'çº¦ç©',
        '2æˆ–å¥½åƒåˆ·å››æ˜Ÿ':'çº¦ç©',
        'ä½ ä»¬æ»¡äº†å—':'çº¦ç©',
        'è¿˜å·®äººå—':'çº¦ç©',
        'å¨æˆ¿2è¹²è½¦è½¦':'çº¦ç©',
        '4kå®éº»1ï¼234':'çº¦ç©',
        '4kèƒšèƒéº»1ï¼234':'çº¦ç©',
        'è¹²ä¸€ä¸ªå››æ˜Ÿè½¦è½¦':'çº¦ç©',
        'å®å®ç»ƒä¹ éº»3=':'çº¦ç©',
        '4æ˜ŸèŠ‚åº†æˆ–è€…å¼€å›¾3=1':'çº¦ç©',
        'æœ‰è½¦å˜›':'çº¦ç©',
        '1ï¼1':'çº¦ç©',
        'éº»å›¢æœ‰äººå‘¢':'çº¦ç©',
        '4.5kéº»2ç­‰123':'çº¦ç©',
        'å®å®ç»ƒä¹ éº»å›¢3=':'çº¦ç©',
        '2=2å››æ˜Ÿ/åˆ·åˆ†æ¥ä¸ªä¼˜è´¨ä¸»æœº':'çº¦ç©',
        'ç­‰ä¸ªå®éº»':'çº¦ç©',
        'é‚£å†²å››æ˜Ÿ':'çº¦ç©',
        'å†²5kéº»2=14':'çº¦ç©',
        'å†²5kéº»3=1':'çº¦ç©',
        'æœ‰è½¦å—ğŸ‘€':'çº¦ç©',
        '2å››æ˜Ÿ':'çº¦ç©',
        'å¨æˆ¿2ï¼Œè¿‡å››æ˜Ÿï¼Œ3=1':'çº¦ç©',
        '2=2':'çº¦ç©',
        '4kèƒšèƒéº»2ï¼23':'çº¦ç©',
        '2åˆ·å››æ˜Ÿ3=1':'çº¦ç©',
        '3=1':'çº¦ç©',
        'æœ‰äººåšé¥­å—':'çº¦ç©',
        'æƒ³æ‰“å››æ˜Ÿ':'çº¦ç©',
        'å…¨éƒ½å¥½åƒå¼€å›¾':'çº¦ç©',
        'è¹²':'çº¦ç©',
        'æˆ‘åœ¨çº¿è¹²steamå¨æˆ¿2ä¸»çº¿æ­å­':'çº¦ç©',
        'SWå¨æˆ¿2ï¼ï¼ï¼':'çº¦ç©',
        'å¨æˆ¿2å››æ˜Ÿ':'çº¦ç©',
        '2ç­‰2':'çº¦ç©',
        'æœ‰ç½‘å¥½çš„å¨æˆ¿2è½¦è½¦ğŸš—å˜›':'çº¦ç©',
        'å¥½åƒåˆ·åˆ†æœ‰æ— ':'çº¦ç©',
        'æœ‰äººç©å—ï¼Œå¨æˆ¿2':'çº¦ç©',
        'æœ‰è½¦è½¦å—':'çº¦ç©',
        'ç°åœ¨æœ‰äººç©å—ï¼Ÿ':'çº¦ç©',
        'è¹²è¹²ä¸€èµ·ä¸»çº¿çš„':'çº¦ç©',
        'ä¸»çº¿å¼€å›¾2ğŸŸ°2':'çº¦ç©',
        '1ç­‰å…¨ä¸–ç•Œ':'çº¦ç©',
        'äºŒç­‰å…¨ä¸–ç•Œ':'çº¦ç©',
        'æŒç»­è¹²è¹²':'çº¦ç©',
        'å¸¦å¸¦æˆ‘':'çº¦ç©',
        'é‚£ç»§ç»­3ï¼1':'çº¦ç©',
        'ä¸‹åˆèŒ¶æœ‰å˜›2=2[è‹¦æ¶©]':'çº¦ç©',
        'æœ‰å¨2è½¦è½¦ğŸš—ä¸':'çº¦ç©',
    }


def init_prompts():
    """
    åˆå§‹åŒ–å‰ç½®promptï¼Œä¾¿äºæ¨¡å‹åš incontext learningã€‚
    """
    unknown = "ä¸çŸ¥é“"
    class_list = list(set(class_examples.values()))
    class_list.append(unknown)
    pre_history = [
        (
            f'ç°åœ¨ä½ æ˜¯ä¸€ä¸ªæ–‡æœ¬åˆ†ç±»å™¨ï¼Œä½ éœ€è¦æŒ‰ç…§è¦æ±‚å°†æˆ‘ç»™ä½ çš„å¥å­åˆ†ç±»åˆ°ï¼š{class_list}ç±»åˆ«ä¸­ã€‚ä¸ç¡®å®šçš„éƒ½è®¤ä¸ºæ˜¯ {unknown} ',
            f'å¥½çš„ã€‚'
        )
    ]

    for exmpale,_type in class_examples.items():
        pre_history.append((f'"{exmpale}" æ˜¯ {class_list} é‡Œçš„ä»€ä¹ˆç±»åˆ«ï¼Ÿ', _type))

    pre_history.append((f' "jfapfa" æ˜¯ {class_list} é‡Œçš„ä»€ä¹ˆç±»åˆ«ï¼Ÿ', unknown))
    pre_history.append((f' "kjzhxc9087   23rha980" æ˜¯ {class_list} é‡Œçš„ä»€ä¹ˆç±»åˆ«ï¼Ÿ', unknown))
    pre_history.append((f' "podiafopi2u0r4iaud098avphn" æ˜¯ {class_list} é‡Œçš„ä»€ä¹ˆç±»åˆ«ï¼Ÿ', unknown))
    pre_history.append((f' "1214556413265415781231" æ˜¯ {class_list} é‡Œçš„ä»€ä¹ˆç±»åˆ«ï¼Ÿ', unknown))
    pre_history.append((f' "å˜¿å˜¿" æ˜¯ {class_list} é‡Œçš„ä»€ä¹ˆç±»åˆ«ï¼Ÿ', unknown))
    pre_history.append((f' "å“ˆå“ˆ" æ˜¯ {class_list} é‡Œçš„ä»€ä¹ˆç±»åˆ«ï¼Ÿ', unknown))
    return {'class_list': class_list, 'pre_history': pre_history}


def inference(
        sentences: list,
        custom_settings: dict
    ):
    """
    æ¨ç†å‡½æ•°ã€‚

    Args:
        sentences (List[str]): å¾…æ¨ç†çš„å¥å­ã€‚
        custom_settings (dict): åˆå§‹è®¾å®šï¼ŒåŒ…å«äººä¸ºç»™å®šçš„ few-shot exampleã€‚
    """
    for sentence in sentences:
        with console.status("[bold bright_green] Model Inference..."):
            sentence_with_prompt = f' "{sentence}" æ˜¯ {custom_settings["class_list"]} é‡Œçš„ä»€ä¹ˆç±»åˆ«ï¼Ÿ'
            response, history = model.chat(tokenizer, sentence_with_prompt, history=custom_settings['pre_history'])
        print(f'>>> [bold bright_red]sentence: {sentence}')
        print(f'>>> [bold bright_green]inference answer: {response}')
        # print(history)


if __name__ == '__main__':
    console = Console()

    device = 'cuda:0'
    tokenizer = AutoTokenizer.from_pretrained("THUDM/chatglm-6b", trust_remote_code=True)
    model = AutoModel.from_pretrained("THUDM/chatglm-6b", trust_remote_code=True).half()
    model.to(device)

    sentences = [
        "æœ‰äººç©å—",
        "è¹²ä¸ªè½¦è½¦",
        "3=1",
        "1ç­‰å…¨ä¸–ç•Œ",
        "æœ‰è½¦å—"
        "2å››æ˜Ÿ",
        "fasdfoaqiuoe",
        "ä¸çŸ¥é“",
        "å“ˆå“ˆ",
        "110938109380-12938-",
    ]
    
    custom_settings = init_prompts()
    inference(
        sentences,
        custom_settings
    )